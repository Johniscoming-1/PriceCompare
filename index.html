<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>One More Tap</title>

<style>
html,body{
    margin:0;
    padding:0;
    background:#000;
    height:100%;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:"Segoe UI",sans-serif;
    color:#fff;
}
canvas{
    width:100vw;
    max-width:420px;
    aspect-ratio:1/1;
}
.flash{ animation:flash 0.15s; }
@keyframes flash{
    from{background:#00ffb0;}
    to{background:#000;}
}
.shake{ animation:shake 0.25s; }
@keyframes shake{
    0%{transform:translate(0);}
    25%{transform:translate(-6px,0);}
    50%{transform:translate(6px,0);}
    75%{transform:translate(-4px,0);}
}
</style>
</head>

<body>
<canvas id="c" width="420" height="420"></canvas>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

let angle = 0;
let renderAngle = 0;
let speed = 0.04;

let score = 0;
let alive = true;

let safeStart = Math.random()*Math.PI*2;
let safeSize  = Math.PI/5;

// ⭐ 核心：最近一次“处于安全区”的时间
let lastSafeTime = 0;

let bestScores = JSON.parse(localStorage.getItem("bestScores")||"[]");
let best = bestScores[0] || 0;

// ---------- 工具 ----------
function norm(a){
    return (a%(Math.PI*2)+Math.PI*2)%(Math.PI*2);
}

// ⭐ 角度 + 宽容
function angleTolerance(){
    return Math.min(0.25, speed * 1.8);
}

// ⭐ 时间宽容（毫秒）—— 真正消灭冤死
function timeTolerance(){
    return Math.min(160, 60 + speed * 1200);
}

// ---------- 判定 ----------
function inSafeAngle(a){
    const tol = angleTolerance();
    let s = norm(safeStart - tol);
    let e = norm(safeStart + safeSize + tol);

    if(s < e) return a >= s && a <= e;
    return a >= s || a <= e;
}

// ---------- 绘制 ----------
function draw(){
    ctx.clearRect(0,0,420,420);
    ctx.save();
    ctx.translate(210,210);

    ctx.beginPath();
    ctx.arc(0,0,140,0,Math.PI*2);
    ctx.strokeStyle="#222";
    ctx.lineWidth=18;
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(
        0,0,140,
        safeStart - Math.PI/2,
        safeStart + safeSize - Math.PI/2
    );
    ctx.strokeStyle="#00ffb0";
    ctx.lineWidth=18;
    ctx.shadowBlur=20;
    ctx.shadowColor="#00ffb0";
    ctx.stroke();
    ctx.shadowBlur=0;

    ctx.rotate(renderAngle);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(0,-155);
    ctx.strokeStyle="#fff";
    ctx.lineWidth=4;
    ctx.stroke();

    ctx.restore();

    ctx.fillStyle="#fff";
    ctx.font="20px Arial";
    ctx.fillText("Score: "+score,20,30);
    ctx.fillText("Best: "+best,20,55);

    if(!alive){
        ctx.fillStyle="#ff5555";
        ctx.font="30px Arial";
        ctx.fillText("失败",170,210);
        ctx.font="16px Arial";
        ctx.fillText("点击重来",165,240);
    }
}

// ---------- 主循环 ----------
function loop(){
    if(alive){
        angle += speed;
        renderAngle = angle;

        const pointer = norm(renderAngle - Math.PI/2);
        if(inSafeAngle(pointer)){
            lastSafeTime = performance.now(); // ⭐ 记录“你确实进过安全区”
        }
    }
    draw();
    requestAnimationFrame(loop);
}

// ---------- 反馈 ----------
function flash(){
    document.body.classList.add("flash");
    setTimeout(()=>document.body.classList.remove("flash"),150);
}
function shake(){
    document.body.classList.add("shake");
    setTimeout(()=>document.body.classList.remove("shake"),250);
}

// ---------- 点击 ----------
function hit(){
    if(!alive){
        angle = 0;
        speed = 0.04;
        score = 0;
        alive = true;
        safeSize = Math.PI/5;
        safeStart = Math.random()*Math.PI*2;
        return;
    }

    const now = performance.now();
    const timeOK = (now - lastSafeTime) <= timeTolerance();

    if(timeOK){
        score++;
        speed += 0.005;
        safeSize *= 0.92;
        safeStart = Math.random()*Math.PI*2;
        flash();
    }else{
        alive = false;
        shake();
        navigator.vibrate?.(200);

        bestScores.push(score);
        bestScores = bestScores.sort((a,b)=>b-a).slice(0,5);
        localStorage.setItem("bestScores",JSON.stringify(bestScores));
        best = bestScores[0];
    }
}

c.addEventListener("click",hit);
window.addEventListener("keydown",e=>{
    if(e.code==="Space") hit();
});

loop();
</script>
</body>
</html>
